LDAvis=function(t,e){function r(t,e){return e="undefined"==typeof e?1:e,function(r,a){return r[t]<a[t]?1*e:r[t]>a[t]?-1*e:0}}var a,n,i,l,o,d={lambda:1,topic:0,term:""},c={old:1,current:1},s="#1f77b4",u="#d62728",p=750,m={top:30,right:30,bottom:70,left:30},f=530,y=530,x=530,h=530,g=90,v=y*f,b=60,T=.25,A=.25,w=.2,E=.6,k=t+"-lambda",B=t.split("#"),I=B[B.length-1],M=I+"-topic",q=I+"-lambda",S=I+"-term",C=M+"-down",z=M+"-up",L=M+"-clear";d3.json(e,function(e,B){function G(t,e,r){var n=document.createElement("div");n.setAttribute("id","top"),n.setAttribute("style","width: 1210px"),document.getElementById(r).appendChild(n);var i=document.createElement("div");i.setAttribute("style","padding: 5px; background-color: #e8e8e8; display: inline-block; width: "+f+"px; height: 50px; float: left"),n.appendChild(i);var l=document.createElement("label");l.setAttribute("for",t),l.setAttribute("style","font-family: sans-serif; font-size: 14px"),l.innerHTML="Selected Topic: <span id='"+t+"-value'></span>",i.appendChild(l);var o=document.createElement("input");o.setAttribute("style","width: 50px"),o.type="text",o.min="0",o.max=a,o.step="1",o.value="0",o.id=t,i.appendChild(o);var c=document.createElement("button");c.setAttribute("id",C),c.setAttribute("style","margin-left: 5px"),c.innerHTML="Previous Topic",i.appendChild(c);var s=document.createElement("button");s.setAttribute("id",z),s.setAttribute("style","margin-left: 5px"),s.innerHTML="Next Topic",i.appendChild(s);var u=document.createElement("button");u.setAttribute("id",L),u.setAttribute("style","margin-left: 5px"),u.innerHTML="Clear Topic",i.appendChild(u);var p=x,m=document.createElement("div");m.setAttribute("id","lambdaInput"),m.setAttribute("style","padding: 5px; background-color: #e8e8e8; display: inline-block; height: 50px; width: "+p+"px; float: right; margin-right: 30px"),n.appendChild(m);var y=document.createElement("div");y.setAttribute("style","padding: 5px; height: 20px; width: 220px; font-family: sans-serif; float: left"),y.setAttribute("id","lambdaZero"),m.appendChild(y);var h=(d3.select("#lambdaZero").append("text").attr("x",0).attr("y",0).style("font-size","14px").text("Slide to adjust relevance metric:"),d3.select("#lambdaZero").append("text").attr("x",125).attr("y",-5).style("font-size","10px").style("position","absolute").text("(2)"),document.createElement("div"));h.setAttribute("id","sliderdiv"),h.setAttribute("style","padding: 5px; height: 40px; width: 250px; float: right; margin-top: -5px; margin-right: 10px"),m.appendChild(h);var g=document.createElement("input");g.setAttribute("style","width: 250px; margin-left: 0px; margin-right: 0px"),g.type="range",g.min=0,g.max=1,g.step=B["lambda.step"],g.value=d.lambda,g.id=e,g.setAttribute("list","ticks"),h.appendChild(g);var v=document.createElement("label");v.setAttribute("id","lamlabel"),v.setAttribute("for",e),v.setAttribute("style","height: 20px; width: 60px; font-family: sans-serif; font-size: 14px; margin-left: 80px"),v.innerHTML="&#955 = <span id='"+e+"-value'>"+d.lambda+"</span>",m.appendChild(v);var b=d3.select("#sliderdiv").append("svg").attr("width",250).attr("height",25),T=d3.scale.linear().domain([0,1]).range([7.5,242.5]).nice(),A=d3.svg.axis().scale(T).orient("bottom").tickSize(10).tickSubdivide(!0).ticks(6);b.append("g").attr("class","slideraxis").attr("margin-top","-10px").call(A)}function F(t){for(var e=o.filter(function(t){return t.Category=="Topic"+d.topic}),a=0;a<e.length;a++)e[a].relevance=d.lambda*e[a].logprob+(1-d.lambda)*e[a].loglift;e.sort(r("relevance"));var i=e.slice(0,n),l=d3.scale.ordinal().domain(i.map(function(t){return t.Term})).rangeRoundBands([0,h],.15),c=d3.scale.linear().domain([0,d3.max(i,function(t){return t.Total})]).range([0,x]).nice(),f=d3.select("#bar-freqs").selectAll(".bar-totals").data(i,function(t){return t.Term}),y=d3.select("#bar-freqs").selectAll(".terms").data(i,function(t){return t.Term}),g=d3.select("#bar-freqs").selectAll(".overlay").data(i,function(t){return t.Term}),v=d3.svg.axis().scale(c).orient("top").tickSize(-h).tickSubdivide(!0).ticks(6),T=d3.selectAll(".xaxis"),A=f.enter().append("rect").attr("class","bar-totals").attr("x",0).attr("y",function(t){return l(t.Term)+h+m.bottom+2*b}).attr("height",l.rangeBand()).style("fill",s).attr("opacity",.4),w=y.enter().append("text").attr("x",-5).attr("class","terms").attr("y",function(t){return l(t.Term)+12+h+m.bottom+2*b}).attr("cursor","pointer").style("text-anchor","end").attr("id",function(t){return S+t.Term}).text(function(t){return t.Term}).on("mouseover",function(){P(this)}).on("mouseout",function(){d.term="",R(this),W(!0)}),E=g.enter().append("rect").attr("class","overlay").attr("x",0).attr("y",function(t){return l(t.Term)+h+m.bottom+2*b}).attr("height",l.rangeBand()).style("fill",u).attr("opacity",.8);t?(A.attr("width",function(t){return c(t.Total)}).transition().duration(p).delay(p).attr("y",function(t){return l(t.Term)}),w.transition().duration(p).delay(p).attr("y",function(t){return l(t.Term)+12}),E.attr("width",function(t){return c(t.Freq)}).transition().duration(p).delay(p).attr("y",function(t){return l(t.Term)}),f.transition().duration(p).attr("width",function(t){return c(t.Total)}).transition().duration(p).attr("y",function(t){return l(t.Term)}),y.transition().duration(p).delay(p).attr("y",function(t){return l(t.Term)+12}),g.transition().duration(p).attr("width",function(t){return c(t.Freq)}).transition().duration(p).attr("y",function(t){return l(t.Term)}),f.exit().transition().duration(p).attr("width",function(t){return c(t.Total)}).transition().duration(p).attr("y",function(t,e){return h+m.bottom+6+18*e}).remove(),y.exit().transition().duration(p).delay(p).attr("y",function(t,e){return h+m.bottom+18+18*e}).remove(),g.exit().transition().duration(p).attr("width",function(t){return c(t.Freq)}).transition().duration(p).attr("y",function(t,e){return h+m.bottom+6+18*e}).remove(),T.transition().duration(p).call(v).transition().duration(p)):(A.attr("width",100).transition().duration(p).attr("y",function(t){return l(t.Term)}).transition().duration(p).attr("width",function(t){return c(t.Total)}),w.transition().duration(p).attr("y",function(t){return l(t.Term)+12}),E.attr("width",50).transition().duration(p).attr("y",function(t){return l(t.Term)}).transition().duration(p).attr("width",function(t){return c(t.Freq)}),f.transition().duration(p).attr("y",function(t){return l(t.Term)}).transition().duration(p).attr("width",function(t){return c(t.Total)}),y.transition().duration(p).attr("y",function(t){return l(t.Term)+12}),g.transition().duration(p).attr("y",function(t){return l(t.Term)}).transition().duration(p).attr("width",function(t){return c(t.Freq)}),f.exit().transition().duration(p).attr("y",function(t,e){return h+m.bottom+6+18*e+2*b}).remove(),y.exit().transition().duration(p).attr("y",function(t,e){return h+m.bottom+18+18*e+2*b}).remove(),g.exit().transition().duration(p).attr("y",function(t,e){return h+m.bottom+6+18*e+2*b}).remove(),T.transition().duration(p).transition().duration(p).call(v))}function _(t){if(null==t)return null;var e=t.__data__,a=Math.round(10*e.Freq)/10,i=e.topics;t.style.opacity=E,t.style.fill=u;var l=d3.select(".bubble-tool");l.remove(),d3.select("#bar-freqs").append("text").attr("x",x/2).attr("y",-30).attr("class","bubble-tool").style("text-anchor","middle").style("font-size","16px").text("Top-"+n+" Most Relevant Terms for Topic "+i+" ("+a+"% of tokens)");for(var d=o.filter(function(t){return t.Category=="Topic"+i}),p=0;p<d.length;p++)d[p].relevance=c.current*d[p].logprob+(1-c.current)*d[p].loglift;d.sort(r("relevance"));var m=d.slice(0,n),f=d3.scale.ordinal().domain(m.map(function(t){return t.Term})).rangeRoundBands([0,h],.15),y=d3.scale.linear().domain([0,d3.max(m,function(t){return t.Total})]).range([0,x]).nice();d3.selectAll(".overlay").remove(),d3.selectAll(".bar-totals").data(m).attr("x",0).attr("y",function(t){return f(t.Term)}).attr("height",f.rangeBand()).attr("width",function(t){return y(t.Total)}).style("fill",s).attr("opacity",.4),d3.selectAll(".terms").data(m).attr("x",-5).attr("y",function(t){return f(t.Term)+12}).attr("id",function(t){return S+t.Term}).style("text-anchor","end").text(function(t){return t.Term}),d3.select("#bar-freqs").selectAll(".overlay").data(m).enter().append("rect").attr("class","overlay").attr("x",0).attr("y",function(t){return f(t.Term)}).attr("height",f.rangeBand()).attr("width",function(t){return y(t.Freq)}).style("fill",u).attr("opacity",.8);var g=d3.svg.axis().scale(y).orient("top").tickSize(-h).tickSubdivide(!0).ticks(6);d3.selectAll(".xaxis").call(g)}function H(t){if(null==t)return t;t.style.opacity=w,t.style.fill=s;var e=d3.selectAll(".bubble-tool").text("Top-"+n+" Most Salient Terms");e.append("tspan").attr("baseline-shift","super").attr("font-size",12).text(1),d3.selectAll(".overlay").remove();var r=o.filter(function(t){return"Default"==t.Category}),a=d3.scale.ordinal().domain(r.map(function(t){return t.Term})).rangeRoundBands([0,h],.15),i=d3.scale.linear().domain([0,d3.max(r,function(t){return t.Total})]).range([0,x]).nice();d3.selectAll(".bar-totals").data(r).attr("x",0).attr("y",function(t){return a(t.Term)}).attr("height",a.rangeBand()).attr("width",function(t){return i(t.Total)}).style("fill",s).attr("opacity",.4),d3.selectAll(".terms").data(r).attr("x",-5).attr("y",function(t){return a(t.Term)+12}).style("text-anchor","end").text(function(t){return t.Term});var l=d3.svg.axis().scale(i).orient("top").tickSize(-h).tickSubdivide(!0).ticks(6);d3.selectAll(".xaxis").attr("class","xaxis").call(l)}function P(t){var e=S+d.term;""!=d.term&&e!=t.id&&R(document.getElementById(e)),d.term=t.innerHTML,D(t),W(!0)}function D(t){if(null==t)return null;t.style.fontWeight="bold";for(var e=t.__data__,r=e.Term,n=l.filter(function(t){return t.Term==r}),o=n.length,d=[],c=0;c<a;++c)d[c]=0;for(c=0;c<o;c++)d[n[c].Topic-1]=n[c].Freq;for(var s=[],c=0;c<a;++c)s[c]=0;for(c=0;c<o;c++)s[n[c].Topic-1]=11;d3.scale.sqrt().domain([0,1]).range([0,b]);d3.selectAll(".dot").data(d).transition().attr("r",function(t){return Math.sqrt(t*f*y*A/Math.PI)}),d3.selectAll(".dot").data(i),d3.selectAll(".txt").data(s).transition().style("font-size",function(t){return+t}),d3.select(".circleGuideTitle").text("Conditional topic distribution given term = '"+t.innerHTML+"'")}function R(t){return null==t?null:(t.style.fontWeight="normal",d3.selectAll(".dot").data(i).transition().attr("r",function(t){return Math.sqrt(t.Freq/100*f*y*T/Math.PI)}),d3.selectAll(".txt").transition().style("font-size","11px"),d3.select(".circleGuideTitle").text("Marginal topic distribution"),d3.select(".circleGuideLabelLarge").text(st),d3.select(".circleGuideLabelSmall").attr("y",y+2*at).text(dt),d3.select(".circleGuideSmall").attr("r",at).attr("cy",y+at),void d3.select(".lineGuideSmall").attr("y1",y+2*at).attr("y2",y+2*at))}function N(){return location.origin+location.pathname+"#topic="+d.topic+"&lambda="+d.lambda+"&term="+d.term}function W(t){t?history.replaceState(d,"Query",N()):history.pushState(d,"Query",N())}function Z(){d.topic>0&&H(document.getElementById(M+d.topic)),""!=d.term&&R(document.getElementById(S+d.term)),d.term="",document.getElementById(M).value=d.topic=0,W(!0)}a=B.mdsDat.x.length,n=B.R,i=[];for(var j=0;j<a;j++){var Q={};for(var O in B.mdsDat)Q[O]=B.mdsDat[O][j];i.push(Q)}l=[];for(var j=0;j<B["token.table"].Term.length;j++){var Q={};for(var O in B["token.table"])Q[O]=B["token.table"][O][j];l.push(Q)}o=[];for(var j=0;j<B.tinfo.Term.length;j++){var Q={};for(var O in B.tinfo)Q[O]=B.tinfo[O][j];o.push(Q)}G(M,q,I),d3.select(k).on("mouseup",function(){c.old=c.current,c.current=document.getElementById(q).value,d.lambda=+this.value,d3.select(k).property("value",d.lambda),d3.select(k+"-value").text(d.lambda);var t=c.old<d.lambda;d.topic>0&&F(t),W(!0),document.getElementById(q).value=d.lambda}),d3.select("#"+z).on("click",function(){var t=document.getElementById(S+d.term);void 0!==t&&R(t),d.term="";var e=document.getElementById(M).value,r=Math.min(a,+e+1).toFixed(0);document.getElementById(M).value=r,H(document.getElementById(M+e)),_(document.getElementById(M+r)),d.topic=r,W(!0)}),d3.select("#"+C).on("click",function(){var t=document.getElementById(S+d.term);void 0!==t&&R(t),d.term="";var e=document.getElementById(M).value,r=Math.max(0,+e-1).toFixed(0);document.getElementById(M).value=r,H(document.getElementById(M+e)),_(document.getElementById(M+r)),d.topic=r,W(!0)}),d3.select("#"+M).on("keyup",function(){var t=document.getElementById(S+d.term);void 0!==t&&R(t),d.term="",H(document.getElementById(M+d.topic));var e=document.getElementById(M).value;!isNaN(e)&&e>0&&(e=Math.min(a,Math.max(1,e)),_(document.getElementById(M+e)),d.topic=e,W(!0),document.getElementById(M).value=d.topic)}),d3.select("#"+L).on("click",function(){Z(),W(!0)});var V=d3.extent(i,function(t){return t.x}),J=V[1]-V[0],K=.05,U=d3.extent(i,function(t){return t.y}),X=U[1]-U[0],Y=.05;if(J>X)var $=d3.scale.linear().range([0,f]).domain([V[0]-K*J,V[1]+K*J]),tt=d3.scale.linear().range([y,0]).domain([U[0]-.5*(J-X)-Y*J,U[1]+.5*(J-X)+Y*J]);else var $=d3.scale.linear().range([0,f]).domain([V[0]-.5*(X-J)-K*X,V[1]+.5*(X-J)+K*X]),tt=d3.scale.linear().range([y,0]).domain([U[0]-Y*X,U[1]+Y*X]);var et=d3.select(t).append("svg").attr("width",f+x+m.left+g+m.right).attr("height",y+2*m.top+m.bottom+2*b),rt=et.append("g").attr("id","leftpanel").attr("class","points").attr("transform","translate("+m.left+","+2*m.top+")");rt.append("rect").attr("x",0).attr("y",0).attr("height",y).attr("width",f).style("fill",s).attr("opacity",0).on("click",function(){Z(),W(!0)}),rt.append("line").attr("x1",0).attr("x2",f).attr("y1",y/2).attr("y2",y/2).attr("stroke","gray").attr("opacity",.3),rt.append("text").attr("x",0).attr("y",y/2-5).text(B["plot.opts"].xlab).attr("fill","gray"),rt.append("line").attr("x1",f/2).attr("x2",f/2).attr("y1",0).attr("y2",y).attr("stroke","gray").attr("opacity",.3),rt.append("text").attr("x",f/2+5).attr("y",7).text(B["plot.opts"].ylab).attr("fill","gray");var at=Math.sqrt(.02*v*T/Math.PI),nt=Math.sqrt(.05*v*T/Math.PI),it=Math.sqrt(.1*v*T/Math.PI),lt=10+it,ot=lt+1.5*it;circleGuide=function(t,e){d3.select("#leftpanel").append("circle").attr("class","circleGuide"+e).attr("r",t).attr("cx",lt).attr("cy",y+t).style("fill","none").style("stroke-dasharray","2 2").style("stroke","#999"),d3.select("#leftpanel").append("line").attr("class","lineGuide"+e).attr("x1",lt).attr("x2",ot).attr("y1",y+2*t).attr("y2",y+2*t).style("stroke","gray").style("opacity",.3)},circleGuide(at,"Small"),circleGuide(nt,"Medium"),circleGuide(it,"Large");var dt="2%",ct="5%",st="10%";d3.select("#leftpanel").append("text").attr("x",10).attr("y",y-10).attr("class","circleGuideTitle").style("text-anchor","left").style("fontWeight","bold").text("Marginal topic distribtion"),d3.select("#leftpanel").append("text").attr("x",ot+10).attr("y",y+2*at).attr("class","circleGuideLabelSmall").style("text-anchor","start").text(dt),d3.select("#leftpanel").append("text").attr("x",ot+10).attr("y",y+2*nt).attr("class","circleGuideLabelMedium").style("text-anchor","start").text(ct),d3.select("#leftpanel").append("text").attr("x",ot+10).attr("y",y+2*it).attr("class","circleGuideLabelLarge").style("text-anchor","start").text(st);var ut=rt.selectAll("points").data(i).enter();ut.append("text").attr("class","txt").attr("x",function(t){return $(+t.x)}).attr("y",function(t){return tt(+t.y)+4}).attr("stroke","black").attr("opacity",1).style("text-anchor","middle").style("font-size","11px").style("fontWeight",100).text(function(t){return t.topics}),ut.append("circle").attr("class","dot").style("opacity",.2).style("fill",s).attr("r",function(t){return Math.sqrt(t.Freq/100*f*y*T/Math.PI)}).attr("cx",function(t){return $(+t.x)}).attr("cy",function(t){return tt(+t.y)}).attr("stroke","black").attr("id",function(t){return M+t.topics}).on("mouseover",function(t){var e=M+d.topic;d.topic>0&&e!=this.id&&H(document.getElementById(e)),_(this)}).on("click",function(t){d3.event.stopPropagation();var e=M+d.topic;d.topic>0&&e!=this.id&&H(document.getElementById(e)),document.getElementById(M).value=d.topic=t.topics,W(!0),_(this)}).on("mouseout",function(t){d.topic!=t.topics&&H(this),d.topic>0&&_(document.getElementById(M+d.topic))}),et.append("text").text("Intertopic Distance Map (via multidimensional scaling)").attr("x",f/2+m.left).attr("y",30).style("font-size","16px").style("text-anchor","middle");var pt=o.filter(function(t){return"Default"==t.Category}),mt=d3.scale.ordinal().domain(pt.map(function(t){return t.Term})).rangeRoundBands([0,h],.15),ft=d3.scale.linear().domain([0,d3.max(pt,function(t){return t.Total})]).range([0,x]).nice(),yt=(d3.svg.axis().scale(mt),et.append("g").attr("transform","translate("+ +(f+m.left+g)+","+2*m.top+")").attr("id","bar-freqs")),xt={width:100,height:15};d3.select("#bar-freqs").append("rect").attr("x",0).attr("y",y+10).attr("height",xt.height).attr("width",xt.width).style("fill",s).attr("opacity",.4),d3.select("#bar-freqs").append("text").attr("x",xt.width+5).attr("y",y+10+xt.height/2).style("dominant-baseline","middle").text("Overall term frequency"),d3.select("#bar-freqs").append("rect").attr("x",0).attr("y",y+10+xt.height+5).attr("height",xt.height).attr("width",xt.width/2).style("fill",u).attr("opacity",.8),d3.select("#bar-freqs").append("text").attr("x",xt.width/2+5).attr("y",y+10+1.5*xt.height+5).style("dominant-baseline","middle").text("Estimated term frequency within the selected topic"),d3.select("#bar-freqs").append("a").attr("xlink:href","http://vis.stanford.edu/files/2012-Termite-AVI.pdf").attr("target","_blank").append("text").attr("x",0).attr("y",y+10+3*xt.height+5).style("dominant-baseline","middle").text("1. saliency(term w) = frequency(w) * [sum_t p(t | w) * log(p(t | w)/p(t))] for topics t; see Chuang et. al (2012)"),d3.select("#bar-freqs").append("a").attr("xlink:href","http://nlp.stanford.edu/events/illvi2014/papers/sievert-illvi2014.pdf").attr("target","_blank").append("text").attr("x",0).attr("y",y+10+4*xt.height+5).style("dominant-baseline","middle").text("2. relevance(term w | topic t) = λ * p(w | t) + (1 - λ) * p(w | t)/p(w); see Sievert & Shirley (2014)");var ht=yt.selectAll(".bar-totals").data(pt).enter();ht.append("rect").attr("class","bar-totals").attr("x",0).attr("y",function(t){return mt(t.Term)}).attr("height",mt.rangeBand()).attr("width",function(t){return ft(t.Total)}).style("fill",s).attr("opacity",.4),ht.append("text").attr("x",-5).attr("class","terms").attr("y",function(t){return mt(t.Term)+12}).attr("cursor","pointer").attr("id",function(t){return S+t.Term}).style("text-anchor","end").text(function(t){return t.Term}).on("mouseover",function(){P(this)}).on("mouseout",function(){d.term="",R(this),W(!0)});var gt=yt.append("text").attr("x",x/2).attr("y",-30).attr("class","bubble-tool").style("text-anchor","middle").style("font-size","16px").text("Top-"+n+" Most Salient Terms");gt.append("tspan").attr("baseline-shift","super").attr("font-size","12px").text("(1)");var vt=d3.svg.axis().scale(ft).orient("top").tickSize(-h).tickSubdivide(!0).ticks(6);yt.attr("class","xaxis").call(vt);var bt=location.hash.split("&");if(bt.length>1){d.topic=bt[0].split("=")[1],d.lambda=bt[1].split("=")[1],d.term=bt[2].split("=")[1],d.topic=Math.round(Math.min(a,Math.max(0,d.topic))),d.lambda=Math.min(1,Math.max(0,d.lambda)),document.getElementById(q).value=d.lambda,document.getElementById(q+"-value").innerHTML=d.lambda,isNaN(d.topic)||(document.getElementById(M).value=d.topic,d.topic>0&&_(document.getElementById(M+d.topic)),d.lambda<1&&d.topic>0&&F(!1)),c.current=d.lambda;var Tt=document.getElementById(S+d.term);void 0!==Tt&&D(Tt)}})};